var CMS=function(t){"use strict";function e(){this.rules=[{regex:/(#+)(.*)/g,replacement:function(t,e,n){var i=e.length;return"<h"+i+">"+n.trim()+"</h"+i+">"}},{regex:/!\[([^[]+)\]\(([^)]+)\)/g,replacement:"<img src='$2' alt='$1'>"},{regex:/\[([^[]+)\]\(([^)]+)\)/g,replacement:"<a href='$2'>$1</a>"},{regex:/(\*\*|__)(.*?)\1/g,replacement:"<strong>$2</strong>"},{regex:/(\*|_)(.*?)\1/g,replacement:"<em>$2</em>"},{regex:/~~(.*?)~~/g,replacement:"<del>$1</del>"},{regex:/:"(.*?)":/g,replacement:"<q>$1</q>"},{regex:/```[a-z]*\n[\s\S]*?\n```/g,replacement:function(t){return"<pre>"+(t=t.replace(/```/gm,"")).trim()+"</pre>"}},{regex:/&&&[a-z]*\n[\s\S]*?\n&&&/g,replacement:function(t){return'<script type="text/javascript">'+(t=t.replace(/```/gm,"")).trim()+"</script>"}},{regex:/`(.*?)`/g,replacement:"<code>$1</code>"},{regex:/\n\*(.*)/g,replacement:function(t,e){return"\n<ul>\n\t<li>"+e.trim()+"</li>\n</ul>"}},{regex:/\n[0-9]+\.(.*)/g,replacement:function(t,e){return"\n<ol>\n\t<li>"+e.trim()+"</li>\n</ol>"}},{regex:/\n(&gt;|>)(.*)/g,replacement:function(t,e,n){return"\n<blockquote>"+n.trim()+"</blockquote>"}},{regex:/\n-{5,}/g,replacement:"\n<hr />"},{regex:/\n([^\n]+)\n/g,replacement:function(t,e){var n=e.trim();return/^<\/?(ul|ol|li|h|p|bl)/i.test(n)?"\n"+e+"\n":"\n<p>"+n+"</p>\n"}},{regex:/<\/ul>\s?<ul>/g,replacement:""},{regex:/<\/ol>\s?<ol>/g,replacement:""},{regex:/<\/blockquote><blockquote>/g,replacement:"\n"}],this.render=function(t){return t="\n"+t+"\n",this.rules.forEach(function(e){t=t.replace(e.regex,e.replacement)}),t.trim()}}function n(t,e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?e(n.response,!1):e(n,n.statusText))},n.send()}function i(t,e){e||(e=window.location.href),t=t.replace(/[[]]/g,"\\$&");var n=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function r(t,e,i){n(t,function(t,n){var r;n&&i(t,n),i((r=t,new Function("data","var output="+JSON.stringify(r).replace(/<%=(.+?)%>/g,'"+($1)+"').replace(/<%(.+?)%>/g,'";$1\noutput+="')+";return output;")(e)),n)})}function s(e,n){a.innerHTML="",r([t.layoutDirectory,"/",e,".html"].join(""),n,function(t,e){e?l(d):a.innerHTML=t})}function o(t){var e=new Date(t);return e.setDate(e.getDate()+1),[e.getDate(),e.getMonth()+1,e.getFullYear()].join("/")}function l(e){return t.debug&&(c.innerHTML=e),e}var a,c;this.ready=!1,this.routes={},this.collections={};var h={elementId:null,layoutDirectory:null,defaultView:null,errorLayout:null,mode:"SERVER",github:null,types:[],plugins:[],frontMatterSeperator:"---",listAttributes:["tags"],dateParser:/\d{4}-\d{2}(?:-\d{2})?/,extension:".md",sort:void 0,markdownEngine:null,debug:!(this.filteredCollections={}),messageClassName:"cms-messages",onload:function(){},onroute:function(){}},u='ERROR: No element ID or ID incorrect. Check "elementId" parameter in config.',f="ERROR: Error getting files. Make sure there is a directory for each type in config with files in it.",g="ERROR: Error getting the file",d="ERROR: Error loading layout. Check the layout file to make sure it exists.",p="WARNING: Not ready to perform action",m=function(t,e){this.type=t,this.layout=e,this.files=[],this[t]=this.files};m.prototype={init:function(t){this.getFiles(function(e,n){n&&l(f),this.loadFiles(function(e,n){n&&l(g),t()}.bind(this))}.bind(this))},getFileListUrl:function(e,n){return"GITHUB"===n.mode?(i=e,r=n.github,s=[r.host,"repos",r.username,r.repo,"contents",i+"?ref="+t.github.branch],r.prefix&&s.splice(5,0,r.prefix),s.join("/")):e;var i,r,s},getFileUrl:function(t,e){return"GITHUB"===e?t.download_url:t.getAttribute("href")},getFileElements:function(e){var n;if("GITHUB"===t.mode)n=JSON.parse(e);else{var i=document.createElement("div");i.innerHTML=e,n=[].slice.call(i.getElementsByTagName("a"))}return n},getFiles:function(e){n(this.getFileListUrl(this.type,t),function(n,i){i&&e(n,i),this.getFileElements(n).forEach(function(e){var n,i,r,s=this.getFileUrl(e,t.mode);n=s,i=t.extension,((r=n.split(".").pop())===i.replace(".","")||"html"===r)&&this.files.push(new y(s,this.type,this.layout.single))}.bind(this)),e(n,i)}.bind(this))},loadFiles:function(t){var e=[];this.files.forEach(function(n,i){n.getContent(function(r,s){s&&t(r,s),e.push(i),n.parseContent(),this.files.length==e.length&&t(r,s)}.bind(this))}.bind(this))},search:function(t,e){this[this.type]=this.files.filter(function(n){return 0<=n[t].toLowerCase().trim().indexOf(e.toLowerCase().trim())})},resetSearch:function(){this[this.type]=this.files},getByTag:function(t){this[this.type]=this.files.filter(function(e){if(t&&e.tags)return e.tags.some(function(e){return e===t})})},getFileByPermalink:function(t){return this.files.filter(function(e){return e.permalink===t})[0]},render:function(){return s(this.layout.list,this)}};var y=function(t,e,n){this.url=t,this.type=e,this.layout=n,this.html=!1,this.content,this.name,this.extension,this.title,this.excerpt,this.date,this.datetime,this.author,this.body,this.permalink,this.tags};y.prototype={getContent:function(t){n(this.url,function(e,n){n&&t(e,n),this.content=e,"string"==typeof this.content&&t(e,n)}.bind(this))},parseFrontMatter:function(){var e=this.content.split(t.frontMatterSeperator)[1];if(e){var n={};e.split(/\n/g).forEach(function(t){var e=t.split(":");e[1]&&(n[e[0].trim()]=e[1].trim())}),function(t,e,n){var i;for(i in void 0===e&&(e=t),e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);n&&n()}(this,n,null)}},setListAttributes:function(){t.listAttributes.forEach(function(t){this.hasOwnProperty(t)&&this[t]&&(this[t]=this[t].split(",").map(function(t){return t.trim()}))}.bind(this))},setFilename:function(){this.name=this.url.substr(this.url.lastIndexOf("/")).replace("/","").replace(t.extension,"")},setPermalink:function(){this.permalink=["#",this.type,this.name].join("/")},setDate:function(){var e=new RegExp(t.dateParser);this.date?(this.datetime=new Date(this.date),this.date=o(this.date)):e.test(this.url)&&(this.date=e.exec(this.url),this.datetime=new Date(this.date),this.date=o(this.date))},setBody:function(){var n=this.content.split(t.frontMatterSeperator).splice(2).join(t.frontMatterSeperator);if(this.html)this.body=n;else if(t.markdownEngine)this.body=t.markdownEngine(n);else{var i=new e;this.body=i.render(n)}},parseContent:function(){this.setFilename(),this.setPermalink(),this.parseFrontMatter(),this.setListAttributes(),this.setDate(),this.setBody()},render:function(){return s(this.layout,this)}},this.sort=function(t,e){this.ready?(this.collections[t][t].sort(e),this.collections[t].render()):l(p)},this.search=function(t,e,n){this.ready?(this.collections[t].search(e,n),this.collections[t].render()):l(p)},this.route=function(){var e=window.location.hash.split("/").map(function(t){return 0<=t.indexOf("?")&&(t=t.substring(0,t.indexOf("?"))),t}).filter(function(t){return"#"!==t}),n=e[0],r=e[1],o=this.collections[n],l=i("query")||"",a=i("tag")||"";return this.routes[n]=function(){if(n)if(r){var e=["#",n,r.trim()].join("/");o.getFileByPermalink(e).render()}else o?(l?o.search("title",l):a?o.getByTag(a):o.resetSearch(),o.render()):s(t.errorLayout,{});else window.location=["#",t.defaultView].join("/");t.onroute()},this.routes[n]()},this.registerPlugins=function(){t.plugins.forEach(function(t){var e,n=e=(e=(e=t.toString()).substr("function ".length)).substr(0,e.indexOf("("));this[n]||(this[n]=t)}.bind(this))},this.initFileCollections=function(e){var n=[],i=[];t.types.forEach(function(t){this.collections[t.name]=new m(t.name,t.layout),i.push(t.name)}.bind(this)),i.forEach(function(t,r){this.collections[t].init(function(){n.push(r),0===t.indexOf("post")&&this.collections[t][t].reverse(),i.length==n.length&&e()}.bind(this))}.bind(this))},this.init=function(){var e;(t=Object.assign({},h,t)).debug&&(e=t.messageClassName,(c=document.createElement("div")).className=e,c.innerHTML="DEBUG",c.style.background="yellow",c.style.position="absolute",c.style.top="0px",document.body.appendChild(c)),window.addEventListener("hashchange",this.route.bind(this)),t.elementId&&(a=document.getElementById(t.elementId))?this.initFileCollections(function(){window.dispatchEvent(new HashChangeEvent("hashchange")),this.ready=!0,this.registerPlugins(),t.onload()}.bind(this)):l(u)},this.init()};